# CoreDNS configuration for docker-cluster plugin
# Listens on port 54 for EdgeRouter compatibility
#
# Split DNS behavior (default):
# - Known container hostnames -> Returns container IP
# - Unknown hostnames -> No response (timeout)
#   EdgeRouter with all-servers queries upstreams in parallel
#
# Environment variable overrides:
#   HOSTIP                       - IP to return for container DNS records
#   DOCKER_SOCKET                - Docker socket path
#   DNS_UNKNOWN_ACTION           - What to do for unknown queries (drop|nxdomain)
#   TRAEFIK_EXTERNALS_ENABLED    - Enable/disable traefik-externals (default: true)
#   TRAEFIK_EXTERNALS_DIRECTORY  - Directory for Traefik external configs

.:54 {
    # Static hosts file for manual DNS entries
    # Edit ./etc/joyride/hosts.d/hosts to add entries (standard hosts file format)
    # Example: 192.168.1.10 nas.example.com
    hosts /etc/hosts.d/hosts {
        fallthrough
    }

    # Custom docker-cluster plugin
    # Watches Docker containers for DNS labels and serves A records
    docker-cluster {
        # Docker socket (override with DOCKER_SOCKET env var)
        docker_socket unix:///var/run/docker.sock

        # Host IP to return for container DNS records
        # IMPORTANT: Override with HOSTIP environment variable in production
        # This placeholder value will be overridden by HOSTIP env var
        host_ip 0.0.0.0

        # Labels to watch for hostnames (both supported for Joyride compatibility)
        label coredns.host.name
        label joyride.host.name

        # TTL for DNS responses (seconds)
        ttl 60

        # What to do when a hostname is not found
        # Options:
        #   drop     - No response (timeout) - default, for split DNS
        #   nxdomain - Return NXDOMAIN - for authoritative setups
        # Can also be set via DNS_UNKNOWN_ACTION env var
        # unknown_action drop
    }

    # Traefik externals plugin
    # Watches Traefik external config files for Host() rules
    # Disable with TRAEFIK_EXTERNALS_ENABLED=false
    traefik-externals {
        # Directory containing Traefik external YAML configs
        # Override with TRAEFIK_EXTERNALS_DIRECTORY env var
        directory /etc/traefik/external-enabled

        # Host IP to return for external service DNS records
        # Uses HOSTIP env var (same as docker-cluster)
        host_ip 0.0.0.0

        # TTL for DNS responses (seconds)
        ttl 60

        # Pass unknown queries to next plugin
        fallthrough
    }

    # Error logging
    errors

    # Health check endpoint on port 5454
    health :5454

    # Prometheus metrics at :9153/metrics
    prometheus :9153

    # Optional: Enable query logging for debugging
    # log
}

# =============================================================================
# ALTERNATIVE: Forward unknown queries to upstream DNS
# =============================================================================
# If you want CoreDNS to forward unknown queries instead of dropping them,
# use this configuration instead. This is useful if your upstream DNS server
# does NOT query multiple sources in parallel (unlike EdgeRouter with all-servers).
#
# .:54 {
#     docker-cluster {
#         docker_socket unix:///var/run/docker.sock
#         host_ip 0.0.0.0  # Override with HOSTIP env var
#         label coredns.host.name
#         label joyride.host.name
#         ttl 60
#         fallthrough
#     }
#
#     # Forward unknown queries to upstream DNS
#     forward . {$DNS_UPSTREAM:8.8.8.8 1.1.1.1}
#
#     errors
#     health :5454
#     prometheus :9153
# }
